[ log sqrt 2 ch/layer]
(py312) lee@AI-LAP:~/Desktop/IaS-ViT$ cd "/home/lee/Desktop/IaS-ViT/" && python3 -u test_quant.py
Namespace(model='deit_tiny', dataset='data/ImageNet', calib_batchsize=128, val_batchsize=200, num_workers=8, device='cuda', print_freq=100, seed=0, w_bits=4, a_bits=4, w_cw=True, a_cw=False, iter=1000, warmup=0.2)
Building dataloader ...
Building model ...
quantization settings: {'n_bits': 4, 'channel_wise': True} | {'n_bits': 4, 'channel_wise': False}

Stage One, Q-Act, FP-W
Init quantization parameters of act
/home/lee/Desktop/IaS-ViT/quant/quantizer.py:272: UserWarning: To copy construct from a tensor, it is recommended to use sourceTensor.clone().detach() or sourceTensor.clone().detach().requires_grad_(True), rather than torch.tensor(sourceTensor).
  log_k = natural_log / torch.log(torch.tensor(k, dtype=x.dtype))
Start optimization
Reconstruction for layer proj
Total loss:     0.000   count=500
Total loss:     0.000   count=1000
Reconstruction for block 0
Total loss:     5.521   count=500
Total loss:     5.445   count=1000
Reconstruction for block 1
Total loss:     1.419   count=500
Total loss:     1.382   count=1000
Reconstruction for block 2
Total loss:     1.093   count=500
Total loss:     1.061   count=1000
Reconstruction for block 3
Total loss:     0.865   count=500
Total loss:     0.838   count=1000
Reconstruction for block 4
Total loss:     0.865   count=500
Total loss:     0.834   count=1000
Reconstruction for block 5
Total loss:     0.941   count=500
Total loss:     0.916   count=1000
Reconstruction for block 6
Total loss:     1.205   count=500
Total loss:     1.173   count=1000
Reconstruction for block 7
Total loss:     1.293   count=500
Total loss:     1.258   count=1000
Reconstruction for block 8
Total loss:     1.843   count=500
Total loss:     1.746   count=1000
Reconstruction for block 9
Total loss:     1.722   count=500
Total loss:     1.653   count=1000
Reconstruction for block 10
Total loss:     0.841   count=500
Total loss:     0.812   count=1000
Reconstruction for block 11
Total loss:     0.729   count=500
Total loss:     0.703   count=1000
Reconstruction for layer head
Total loss:     1.890   count=500
Total loss:     1.452   count=1000
Acc after Stage One: 
Test: [0/250]   Time 2.603 (2.603)      Loss 1.1351 (1.1351)    Prec@1 73.500 (73.500)  Prec@5 95.500 (95.500)
Test: [100/250] Time 0.325 (0.351)      Loss 2.0360 (1.3362)    Prec@1 53.500 (71.713)  Prec@5 81.000 (91.584)
Test: [200/250] Time 0.323 (0.338)      Loss 0.9680 (1.6337)    Prec@1 82.000 (65.669)  Prec@5 94.500 (87.286)
 * Prec@1 65.014 Prec@5 86.938 Time 83.767

Stage Two, reparameterization
Stage Three, Q-Act, Q-W
Init quantization parameters of weight
re optimization
Reconstruction for layer proj
Total loss:     1.770   count=500
Total loss:     0.331   count=1000
Reconstruction for block 0
Total loss:     6.828   count=500
Total loss:     5.858   count=1000
Reconstruction for block 1
Total loss:     5.505   count=500
Total loss:     5.223   count=1000
Reconstruction for block 2
Total loss:     5.865   count=500
Total loss:     5.522   count=1000
Reconstruction for block 3
Total loss:     6.671   count=500
Total loss:     6.411   count=1000
Reconstruction for block 4
Total loss:     7.585   count=500
Total loss:     7.528   count=1000
Reconstruction for block 5
Total loss:     9.623   count=500
Total loss:     9.185   count=1000
Reconstruction for block 6
Total loss:     12.122  count=500
Total loss:     11.747  count=1000
Reconstruction for block 7
Total loss:     17.070  count=500
Total loss:     16.569  count=1000
Reconstruction for block 8
Total loss:     25.232  count=500
Total loss:     24.859  count=1000
Reconstruction for block 9
Total loss:     33.941  count=500
Total loss:     35.000  count=1000
Reconstruction for block 10
Total loss:     39.507  count=500
Total loss:     40.214  count=1000
Reconstruction for block 11
Total loss:     40.260  count=500
Total loss:     39.448  count=1000
Reconstruction for layer head
Total loss:     95.247  count=500
Total loss:     80.818  count=1000
Acc after re optimization
Test: [0/250]   Time 2.761 (2.761)      Loss 1.2291 (1.2291)    Prec@1 72.500 (72.500)  Prec@5 95.500 (95.500)
Test: [100/250] Time 0.340 (0.363)      Loss 2.0787 (1.4325)    Prec@1 51.500 (69.827)  Prec@5 79.000 (90.797)
Test: [200/250] Time 0.333 (0.350)      Loss 0.9406 (1.7302)    Prec@1 83.500 (63.940)  Prec@5 93.500 (86.274)
 * Prec@1 63.272 Prec@5 85.826 Time 86.813

==============================================================
==============================================================
==============================================================
==============================================================
==============================================================

[ log 2 ch/layer]
(py312) lee@AI-LAP:~/Desktop/IaS-ViT$ python test_quant.py 
Namespace(model='deit_tiny', dataset='data/ImageNet', calib_batchsize=128, val_batchsize=200, num_workers=8, device='cuda', print_freq=100, seed=0, w_bits=4, a_bits=4, w_cw=True, a_cw=False, iter=1000, warmup=0.2)
Building dataloader ...
Building model ...
quantization settings: {'n_bits': 4, 'channel_wise': True} | {'n_bits': 4, 'channel_wise': False}

Stage One, Q-Act, FP-W
Init quantization parameters of act
Start optimization
Reconstruction for layer proj
Total loss:     0.000   count=500
Total loss:     0.000   count=1000
Reconstruction for block 0
Total loss:     5.765   count=500
Total loss:     5.684   count=1000
Reconstruction for block 1
Total loss:     1.534   count=500
Total loss:     1.499   count=1000
Reconstruction for block 2
Total loss:     1.170   count=500
Total loss:     1.139   count=1000
Reconstruction for block 3
Total loss:     0.971   count=500
Total loss:     0.940   count=1000
Reconstruction for block 4
Total loss:     0.868   count=500
Total loss:     0.842   count=1000
Reconstruction for block 5
Total loss:     0.927   count=500
Total loss:     0.904   count=1000
Reconstruction for block 6
Total loss:     1.305   count=500
Total loss:     1.270   count=1000
Reconstruction for block 7
Total loss:     1.394   count=500
Total loss:     1.353   count=1000
Reconstruction for block 8
Total loss:     1.933   count=500
Total loss:     1.840   count=1000
Reconstruction for block 9
Total loss:     1.701   count=500
Total loss:     1.634   count=1000
Reconstruction for block 10
Total loss:     0.921   count=500
Total loss:     0.891   count=1000
Reconstruction for block 11
Total loss:     0.834   count=500
Total loss:     0.804   count=1000
Reconstruction for layer head
Total loss:     1.834   count=500
Total loss:     1.440   count=1000
Acc after Stage One: 
Test: [0/250]   Time 2.803 (2.803)      Loss 1.0477 (1.0477)    Prec@1 80.500 (80.500)  Prec@5 97.500 (97.500)
Test: [100/250] Time 0.237 (0.280)      Loss 2.0495 (1.3290)    Prec@1 51.500 (71.639)  Prec@5 82.500 (91.738)
Test: [200/250] Time 0.236 (0.261)      Loss 0.9438 (1.6335)    Prec@1 84.500 (65.896)  Prec@5 95.000 (87.333)
 * Prec@1 65.216 Prec@5 86.964 Time 64.152

Stage Two, reparameterization
Stage Three, Q-Act, Q-W
Init quantization parameters of weight
re optimization
Reconstruction for layer proj
Total loss:     1.770   count=500
Total loss:     0.331   count=1000
Reconstruction for block 0
Total loss:     7.021   count=500
Total loss:     6.038   count=1000
Reconstruction for block 1
Total loss:     5.648   count=500
Total loss:     5.371   count=1000
Reconstruction for block 2
Total loss:     6.038   count=500
Total loss:     5.689   count=1000
Reconstruction for block 3
Total loss:     6.895   count=500
Total loss:     6.622   count=1000
Reconstruction for block 4
Total loss:     7.792   count=500
Total loss:     7.689   count=1000
Reconstruction for block 5
Total loss:     9.738   count=500
Total loss:     9.364   count=1000
Reconstruction for block 6
Total loss:     12.369  count=500
Total loss:     11.928  count=1000
Reconstruction for block 7
Total loss:     17.353  count=500
Total loss:     16.775  count=1000
Reconstruction for block 8
Total loss:     25.736  count=500
Total loss:     25.165  count=1000
Reconstruction for block 9
Total loss:     34.384  count=500
Total loss:     35.524  count=1000
Reconstruction for block 10
Total loss:     40.132  count=500
Total loss:     40.083  count=1000
Reconstruction for block 11
Total loss:     40.630  count=500
Total loss:     40.132  count=1000
Reconstruction for layer head
Total loss:     99.814  count=500
Total loss:     84.718  count=1000
Acc after re optimization
Test: [0/250]   Time 2.223 (2.223)      Loss 1.0737 (1.0737)    Prec@1 75.000 (75.000)  Prec@5 95.500 (95.500)
Test: [100/250] Time 0.208 (0.238)      Loss 2.0783 (1.4361)    Prec@1 52.000 (69.649)  Prec@5 81.000 (90.624)
Test: [200/250] Time 0.206 (0.225)      Loss 1.0166 (1.7384)    Prec@1 84.500 (63.960)  Prec@5 95.000 (86.127)
 * Prec@1 63.328 Prec@5 85.752 Time 55.481
==============================================================
==============================================================
==============================================================
==============================================================
==============================================================


[ log sqrt 2 ch/ch]
(py312) lee@AI-LAP:~/Desktop/IaS-ViT$ cd "/home/lee/Desktop/IaS-ViT/" && python3 -u test_quant.py
Namespace(model='deit_tiny', dataset='data/ImageNet', calib_batchsize=128, val_batchsize=200, num_workers=8, device='cuda', print_freq=100, seed=0, w_bits=4, a_bits=4, w_cw=True, a_cw=True, iter=1000, warmup=0.2)
Building dataloader ...
Building model ...
quantization settings: {'n_bits': 4, 'channel_wise': True} | {'n_bits': 4, 'channel_wise': True}

Stage One, Q-Act, FP-W
Init quantization parameters of act
/home/lee/Desktop/IaS-ViT/quant/quantizer.py:273: UserWarning: To copy construct from a tensor, it is recommended to use sourceTensor.clone().detach() or sourceTensor.clone().detach().requires_grad_(True), rather than torch.tensor(sourceTensor).
  log_k = natural_log / torch.log(torch.tensor(k, dtype=x.dtype))
Start optimization
Reconstruction for layer proj
Total loss:     0.000   count=500
Total loss:     0.000   count=1000
Reconstruction for block 0
Total loss:     3.831   count=500
Total loss:     3.787   count=1000
Reconstruction for block 1
Total loss:     1.128   count=500
Total loss:     1.108   count=1000
Reconstruction for block 2
Total loss:     0.921   count=500
Total loss:     0.900   count=1000
Reconstruction for block 3
Total loss:     0.752   count=500
Total loss:     0.730   count=1000
Reconstruction for block 4
Total loss:     0.707   count=500
Total loss:     0.690   count=1000
Reconstruction for block 5
Total loss:     0.841   count=500
Total loss:     0.826   count=1000
Reconstruction for block 6
Total loss:     1.157   count=500
Total loss:     1.127   count=1000
Reconstruction for block 7
Total loss:     1.312   count=500
Total loss:     1.284   count=1000
Reconstruction for block 8
Total loss:     1.743   count=500
Total loss:     1.674   count=1000
Reconstruction for block 9
Total loss:     1.583   count=500
Total loss:     1.528   count=1000
Reconstruction for block 10
Total loss:     0.756   count=500
Total loss:     0.735   count=1000
Reconstruction for block 11
Total loss:     0.525   count=500
Total loss:     0.512   count=1000
Reconstruction for layer head
Total loss:     2.687   count=500
Total loss:     1.999   count=1000
Acc after Stage One: 
Test: [0/250]   Time 4.861 (4.861)      Loss 1.0827 (1.0827)    Prec@1 76.000 (76.000)  Prec@5 95.500 (95.500)
Test: [100/250] Time 0.453 (0.483)      Loss 2.1842 (1.2879)    Prec@1 48.500 (71.559)   Prec@5 80.500 (91.847)
Test: [200/250] Time 0.236 (0.423)      Loss 0.9177 (1.6137)    Prec@1 84.000 (65.517)   Prec@5 94.000 (87.383)
 * Prec@1 64.988 Prec@5 87.056 Time 96.800

Stage Two, reparameterization
Stage Three, Q-Act, Q-W
Init quantization parameters of weight
re optimization
Reconstruction for layer proj
Total loss:     1.770   count=500
Total loss:     0.331   count=1000
Reconstruction for block 0
Total loss:     5.624   count=500
Total loss:     4.550   count=1000
Reconstruction for block 1
Total loss:     4.574   count=500
Total loss:     4.258   count=1000
Reconstruction for block 2
Total loss:     5.007   count=500
Total loss:     4.646   count=1000
Reconstruction for block 3
Total loss:     5.786   count=500
Total loss:     5.525   count=1000
Reconstruction for block 4
Total loss:     6.600   count=500
Total loss:     6.540   count=1000
Reconstruction for block 5
Total loss:     8.517   count=500
Total loss:     8.088   count=1000
Reconstruction for block 6
Total loss:     10.850  count=500
Total loss:     10.535  count=1000
Reconstruction for block 7
Total loss:     15.371  count=500
Total loss:     14.849  count=1000
Reconstruction for block 8
Total loss:     22.780  count=500
Total loss:     22.379  count=1000
Reconstruction for block 9
Total loss:     30.114  count=500
Total loss:     31.517  count=1000
Reconstruction for block 10
Total loss:     35.712  count=500
Total loss:     34.861  count=1000
Reconstruction for block 11
Total loss:     36.413  count=500
Total loss:     35.610  count=1000
Reconstruction for layer head
Total loss:     125.463         count=500
Total loss:     107.039         count=1000
Acc after re optimization
Test: [0/250]   Time 4.449 (4.449)      Loss 1.1823 (1.1823)    Prec@1 76.000 (76.000)   Prec@5 95.000 (95.000)
Test: [100/250] Time 0.324 (0.491)      Loss 2.3264 (1.4739)    Prec@1 50.500 (69.752)   Prec@5 78.000 (90.911)
Test: [200/250] Time 0.206 (0.443)      Loss 0.9598 (1.8022)    Prec@1 85.500 (63.619)   Prec@5 95.500 (86.231)
 * Prec@1 62.964 Prec@5 85.718 Time 99.334
==============================================================
==============================================================
==============================================================
==============================================================
==============================================================

[ log  2 ch/ch]
(py312) lee@AI-LAP:~/Desktop/IaS-ViT$ python test_quant.py 
Namespace(model='deit_tiny', dataset='data/ImageNet', calib_batchsize=128, val_batchsize=200, num_workers=8, device='cuda', print_freq=100, seed=0, w_bits=4, a_bits=4, w_cw=True, a_cw=True, iter=1000, warmup=0.2)
Building dataloader ...
Building model ...
quantization settings: {'n_bits': 4, 'channel_wise': True} | {'n_bits': 4, 'channel_wise': True}

Stage One, Q-Act, FP-W
Init quantization parameters of act
Start optimization
Reconstruction for layer proj
Total loss:     0.000   count=500
Total loss:     0.000   count=1000
Reconstruction for block 0
Total loss:     4.035   count=500
Total loss:     4.048   count=1000
Reconstruction for block 1
Total loss:     1.231   count=500
Total loss:     1.214   count=1000
Reconstruction for block 2
Total loss:     1.008   count=500
Total loss:     0.991   count=1000
Reconstruction for block 3
Total loss:     0.842   count=500
Total loss:     0.816   count=1000
Reconstruction for block 4
Total loss:     0.781   count=500
Total loss:     0.760   count=1000
Reconstruction for block 5
Total loss:     0.880   count=500
Total loss:     0.861   count=1000
Reconstruction for block 6
Total loss:     1.222   count=500
Total loss:     1.195   count=1000
Reconstruction for block 7
Total loss:     1.363   count=500
Total loss:     1.344   count=1000
Reconstruction for block 8
Total loss:     1.840   count=500
Total loss:     1.755   count=1000
Reconstruction for block 9
Total loss:     1.673   count=500
Total loss:     1.630   count=1000
Reconstruction for block 10
Total loss:     0.815   count=500
Total loss:     0.794   count=1000
Reconstruction for block 11
Total loss:     0.601   count=500
Total loss:     0.582   count=1000
Reconstruction for layer head
Total loss:     2.487   count=500
Total loss:     1.842   count=1000
Acc after Stage One: 
Test: [0/250]   Time 2.891 (2.891)      Loss 1.0430 (1.0430)    Prec@1 76.500 (76.500)  Prec@5 95.000 (95.000)
Test: [100/250] Time 0.423 (0.369)      Loss 2.0742 (1.2611)    Prec@1 52.000 (71.743)  Prec@5 82.500 (92.045)
Test: [200/250] Time 0.339 (0.399)      Loss 0.8705 (1.5951)    Prec@1 84.000 (65.848)   Prec@5 95.500 (87.667)
 * Prec@1 65.290 Prec@5 87.262 Time 100.317

Stage Two, reparameterization
Stage Three, Q-Act, Q-W
Init quantization parameters of weight
re optimization
Reconstruction for layer proj
Total loss:     1.770   count=500
Total loss:     0.331   count=1000
Reconstruction for block 0
Total loss:     5.978   count=500
Total loss:     4.808   count=1000
Reconstruction for block 1
Total loss:     4.712   count=500
Total loss:     4.427   count=1000
Reconstruction for block 2
Total loss:     5.216   count=500
Total loss:     4.866   count=1000
Reconstruction for block 3
Total loss:     6.037   count=500
Total loss:     5.769   count=1000
Reconstruction for block 4
Total loss:     6.925   count=500
Total loss:     6.839   count=1000
Reconstruction for block 5
Total loss:     8.771   count=500
Total loss:     8.437   count=1000
Reconstruction for block 6
Total loss:     11.220  count=500
Total loss:     10.849  count=1000
Reconstruction for block 7
Total loss:     15.731  count=500
Total loss:     15.433  count=1000
Reconstruction for block 8
Total loss:     23.646  count=500
Total loss:     23.235  count=1000
Reconstruction for block 9
Total loss:     31.508  count=500
Total loss:     32.994  count=1000
Reconstruction for block 10
Total loss:     36.899  count=500
Total loss:     37.324  count=1000
Reconstruction for block 11
Total loss:     37.841  count=500
Total loss:     37.054  count=1000
Reconstruction for layer head
Total loss:     128.358         count=500
Total loss:     112.049         count=1000
Acc after re optimization
Test: [0/250]   Time 2.606 (2.606)      Loss 1.3132 (1.3132)    Prec@1 68.000 (68.000)   Prec@5 95.000 (95.000)
Test: [100/250] Time 0.385 (0.393)      Loss 2.1132 (1.4615)    Prec@1 51.000 (69.287)   Prec@5 82.000 (90.896)
Test: [200/250] Time 0.428 (0.408)      Loss 1.1214 (1.7938)    Prec@1 84.000 (63.495)   Prec@5 95.000 (86.326)
 * Prec@1 62.766 Prec@5 85.830 Time 102.838